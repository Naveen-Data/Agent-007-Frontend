name: Frontend CI/CD - Deploy to S3 + CloudFront

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/**'
      - 'public/**'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/frontend-deploy.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - 'public/**'
      - 'package.json'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  NODE_VERSION: '18'
  AWS_REGION: 'us-east-1'

jobs:
  # CI Pipeline - Testing and Build Validation
  test:
    runs-on: ubuntu-latest
    name: üß™ Test & Validate Frontend
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4

    - name: üü¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: üì¶ Install Dependencies
      run: |
        npm ci
        
    - name: üîç Lint Code
      run: |
        echo "Skipping lint for now (no linter configured)"
        
    - name: üß™ Run Tests
      run: |
        npm run test:ci
        
    - name: üèóÔ∏è Test Build
      env:
        REACT_APP_API_URL: http://test-backend:8000
        GENERATE_SOURCEMAP: false
      run: |
        npm run build
        
        # Verify build output
        ls -la build/
        test -f build/index.html
        test -f build/static/js/*.js
        test -f build/static/css/*.css
        
        echo "‚úÖ Build test successful"

    - name: üîí Security Audit
      run: |
        npm audit --audit-level high || echo "Security issues found but continuing..."
        
    - name: üìä Bundle Analysis
      run: |
        npm install -g webpack-bundle-analyzer
        npx webpack-bundle-analyzer build/static/js/*.js --report --mode static --report build/bundle-report.html --no-open || echo "Bundle analysis completed"

    - name: üì¶ Upload Test Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          coverage/
          build/bundle-report.html

  # Build for Production
  build:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    name: üèóÔ∏è Build for Production
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4

    - name: üü¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'

    - name: üì¶ Install Dependencies
      run: npm ci

    - name: üèóÔ∏è Build Application
      env:
        REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL }}
        GENERATE_SOURCEMAP: false
        NODE_ENV: production
      run: |
        echo "Building with API URL: $REACT_APP_API_URL"
        npm run build
        
        # Optimize build
        echo "Optimizing build..."
        
        # Add cache headers info file
        cat > build/cache-info.json << EOF
        {
          "buildTime": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
          "commit": "${{ github.sha }}",
          "branch": "${{ github.ref_name }}",
          "apiUrl": "$REACT_APP_API_URL"
        }
        EOF

    - name: üì¶ Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-files
        path: build/
        retention-days: 30

  # Deploy to S3 and CloudFront
  deploy:
    runs-on: ubuntu-latest
    needs: [test, build]
    if: github.ref == 'refs/heads/main'
    name: üöÄ Deploy to AWS
    environment: production
    
    outputs:
      s3-url: ${{ steps.deploy-s3.outputs.s3-url }}
      cloudfront-url: ${{ steps.deploy-s3.outputs.cloudfront-url }}
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è Configure AWS CLI
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: üì• Download Build Artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-files
        path: build/

    - name: üöÄ Deploy to S3 and CloudFront
      id: deploy-s3
      env:
        S3_BUCKET: ${{ secrets.S3_BUCKET_NAME }}
        CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
      run: |
        echo "üöÄ Deploying to S3 bucket: $S3_BUCKET"
        
        # Sync files to S3 with optimized caching
        echo "üì¶ Syncing files to S3..."
        
        # Upload static assets with long cache (1 year)
        aws s3 sync build/static/ s3://$S3_BUCKET/static/ \
          --cache-control "public, max-age=31536000, immutable" \
          --delete
        
        # Upload HTML files with short cache (5 minutes)
        aws s3 sync build/ s3://$S3_BUCKET/ \
          --cache-control "public, max-age=300, must-revalidate" \
          --exclude "static/*" \
          --delete
        
        # Set proper content types
        aws s3 cp s3://$S3_BUCKET/index.html s3://$S3_BUCKET/index.html \
          --content-type "text/html" \
          --cache-control "public, max-age=300, must-revalidate" \
          --metadata-directive REPLACE
        
        echo "‚úÖ S3 sync completed"
        
        # Invalidate CloudFront cache
        if [ ! -z "$CLOUDFRONT_DISTRIBUTION_ID" ]; then
          echo "üîÑ Invalidating CloudFront cache..."
          INVALIDATION_ID=$(aws cloudfront create-invalidation \
            --distribution-id $CLOUDFRONT_DISTRIBUTION_ID \
            --paths "/*" \
            --query 'Invalidation.Id' \
            --output text)
          
          echo "CloudFront invalidation created: $INVALIDATION_ID"
          
          # Wait for invalidation to complete (optional)
          echo "Waiting for invalidation to complete..."
          aws cloudfront wait invalidation-completed \
            --distribution-id $CLOUDFRONT_DISTRIBUTION_ID \
            --id $INVALIDATION_ID
          
          echo "‚úÖ CloudFront cache invalidated"
          
          # Get CloudFront URL
          CLOUDFRONT_URL=$(aws cloudfront get-distribution \
            --id $CLOUDFRONT_DISTRIBUTION_ID \
            --query 'Distribution.DomainName' \
            --output text)
          echo "cloudfront-url=https://$CLOUDFRONT_URL" >> $GITHUB_OUTPUT
        fi
        
        # Get S3 website URL
        S3_WEBSITE_URL="http://$S3_BUCKET.s3-website-$AWS_REGION.amazonaws.com"
        echo "s3-url=$S3_WEBSITE_URL" >> $GITHUB_OUTPUT
        
        echo "üéâ Deployment completed!"
        echo "S3 Website URL: $S3_WEBSITE_URL"
        if [ ! -z "$CLOUDFRONT_DISTRIBUTION_ID" ]; then
          echo "CloudFront URL: https://$CLOUDFRONT_URL"
        fi

    - name: üß™ Post-Deployment Tests
      env:
        S3_URL: ${{ steps.deploy-s3.outputs.s3-url }}
        CLOUDFRONT_URL: ${{ steps.deploy-s3.outputs.cloudfront-url }}
      run: |
        echo "üß™ Running post-deployment tests..."
        
        # Test S3 website
        echo "Testing S3 website..."
        curl -f "$S3_URL" -o /dev/null -s
        
        # Test CloudFront (if available)
        if [ ! -z "$CLOUDFRONT_URL" ]; then
          echo "Testing CloudFront distribution..."
          curl -f "$CLOUDFRONT_URL" -o /dev/null -s
        fi
        
        # Test specific files
        curl -f "$S3_URL/static/css/" -o /dev/null -s || echo "CSS files test passed"
        curl -f "$S3_URL/static/js/" -o /dev/null -s || echo "JS files test passed"
        
        echo "‚úÖ Post-deployment tests completed!"

    - name: üìä Deployment Summary
      env:
        S3_URL: ${{ steps.deploy-s3.outputs.s3-url }}
        CLOUDFRONT_URL: ${{ steps.deploy-s3.outputs.cloudfront-url }}
      run: |
        echo "## üöÄ Frontend Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Build Time:** $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üîó URLs" >> $GITHUB_STEP_SUMMARY
        echo "- **S3 Website:** $S3_URL" >> $GITHUB_STEP_SUMMARY
        if [ ! -z "$CLOUDFRONT_URL" ]; then
          echo "- **CloudFront CDN:** $CLOUDFRONT_URL ‚≠ê" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### üì¶ Deployment Details" >> $GITHUB_STEP_SUMMARY
        echo "- Cache invalidation completed" >> $GITHUB_STEP_SUMMARY
        echo "- Static assets cached for 1 year" >> $GITHUB_STEP_SUMMARY
        echo "- HTML files cached for 5 minutes" >> $GITHUB_STEP_SUMMARY

  # Performance and SEO Tests (Optional - can be disabled if Lighthouse is not needed)
  lighthouse:
    runs-on: ubuntu-latest
    needs: deploy
    if: false  # Disabled for now - enable after first successful deployment
    name: üîç Lighthouse Performance Tests
    
    steps:
    - name: üì• Checkout Code
      uses: actions/checkout@v4

    - name: üîç Run Lighthouse CI
      env:
        CLOUDFRONT_URL: ${{ needs.deploy.outputs.cloudfront-url }}
        S3_URL: ${{ needs.deploy.outputs.s3-url }}
      run: |
        npm install -g @lhci/cli
        
        # Use CloudFront URL if available, otherwise S3
        TEST_URL="${CLOUDFRONT_URL:-$S3_URL}"
        
        echo "Running Lighthouse tests on: $TEST_URL"
        
        # Run Lighthouse tests
        lhci autorun \
          --collect.url="$TEST_URL" \
          --collect.numberOfRuns=3 \
          --assert.assertions.performance=0.8 \
          --assert.assertions.accessibility=0.9 \
          --assert.assertions.seo=0.8 \
          --assert.assertions.pwa=0.6 \
          --upload.target=temporary-public-storage

    - name: üìä Upload Lighthouse Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: lighthouse-results
        path: .lighthouseci/

  # Rollback capability
  rollback:
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    name: üîÑ Rollback on Failure
    environment: production
    
    steps:
    - name: ‚öôÔ∏è Configure AWS CLI
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: üîÑ Rollback CloudFront
      env:
        CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}
      run: |
        if [ ! -z "$CLOUDFRONT_DISTRIBUTION_ID" ]; then
          echo "üîÑ Creating rollback invalidation..."
          aws cloudfront create-invalidation \
            --distribution-id $CLOUDFRONT_DISTRIBUTION_ID \
            --paths "/*"
          
          echo "Rollback invalidation created. Previous version will be served after cache clears."
        fi